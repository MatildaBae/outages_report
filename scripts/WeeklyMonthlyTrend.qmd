---
title: "Weekly and Monthly Trends"
authors: Jiwon Bae (jb5234) and Hillary Rodriguez (hnr2112)
execute:
  echo: true
  warning: false
  message: false
format:
  html:
    fig-width: 6
    fig-height: 4
    out-width: 60%
    embed-resources: true
---

```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(lubridate)
  library(fs)
})

data_path <- fs::path("..", "data", "PackageData.csv")

outages_raw <- readr::read_csv(data_path, show_col_types = FALSE)
```

Prepare outage data with week & month
```{r}
prepare_outages <- function(df) {
  df |>
    mutate(
      start_ts = ymd_hms(STARTDATE, tz = "UTC", quiet = TRUE),
      rest_ts  = ymd_hms(RESTDATE,  tz = "UTC", quiet = TRUE),
      duration_hours = as.numeric(difftime(rest_ts, start_ts, units = "hours")),
      outage_day   = as.Date(start_ts),
      outage_week  = floor_date(outage_day, unit = "week", week_start = 1),
      outage_month = floor_date(outage_day, unit = "month")
      ) |>
    filter(
      !is.na(outage_day),
      !is.na(duration_hours),
      duration_hours >= 0
    )
  }

outages <- prepare_outages(outages_raw)

```

# Weekly & monthly summaries
```{r}
summarise_weekly_outages <- function(df) {
  df |>
    group_by(outage_week) |>
    summarise(
      total_outages      = n(),
      total_customers    = sum(TOTALCUSTAFFECTED %||% 0, na.rm = TRUE),
      customer_hours_lost = sum((TOTALCUSTAFFECTED %||% 0) * duration_hours,
                                na.rm = TRUE),
      .groups = "drop"
      ) |>
    arrange(outage_week)
  }

summarise_monthly_outages <- function(df) {
  df |>
    group_by(outage_month) |>
    summarise(
      total_outages      = n(),
      total_customers    = sum(TOTALCUSTAFFECTED %||% 0, na.rm = TRUE),
      customer_hours_lost = sum((TOTALCUSTAFFECTED %||% 0) * duration_hours,
                                na.rm = TRUE),
      .groups = "drop"
      ) |>
    arrange(outage_month)
  }

weekly_summary  <- summarise_weekly_outages(outages)
monthly_summary <- summarise_monthly_outages(outages)

head(weekly_summary)
head(monthly_summary)

```

# Plot helpers
```{r}
filter_weekly_range <- function(df, start_week = NULL, end_week = NULL) {
  df <- df |> mutate(outage_week = as.Date(outage_week))

  if (!is.null(start_week) || !is.null(end_week)) {
    if (is.null(start_week)) start_week <- min(df$outage_week, na.rm = TRUE)
    if (is.null(end_week))   end_week   <- max(df$outage_week, na.rm = TRUE)
    
    df <- df |>
      filter(outage_week >= start_week,
             outage_week <= end_week)}
  df
  }

filter_monthly_range <- function(df, start_month = NULL, end_month = NULL) {
  df <- df |> mutate(outage_month = as.Date(outage_month))
  
  if (!is.null(start_month) || !is.null(end_month)) {
    if (is.null(start_month)) start_month <- min(df$outage_month, na.rm = TRUE)
    if (is.null(end_month))   end_month   <- max(df$outage_month, na.rm = TRUE)

    df <- df |>
      filter(outage_month >= start_month,
             outage_month <= end_month)
    }
  df
  }

# Outages per week
plot_outages_per_week <- function(weekly_df,
                                  start_week = NULL,
                                  end_week   = NULL) {
  df <- filter_weekly_range(weekly_df, start_week, end_week)
  ymax <- max(df$total_outages, na.rm = TRUE)
  
  ggplot(df, aes(x = outage_week, y = total_outages)) +
    geom_col(width = 7) +
    scale_y_continuous(limits = c(0, ymax * 1.1)) +
    scale_x_date(date_labels = "%Y-%m-%d") +
    labs(
      x = "Week",
      y = "Total outages",
      title = "Outages per week") +
    theme_minimal()
  }

# Outages per month
plot_outages_per_month <- function(monthly_df,
                                   start_month = NULL,
                                   end_month   = NULL) {
  df <- filter_monthly_range(monthly_df, start_month, end_month)
  ymax <- max(df$total_outages, na.rm = TRUE)
  
  ggplot(df, aes(x = outage_month, y = total_outages)) +
    geom_col(width = 25) +
    scale_y_continuous(limits = c(0, ymax * 1.1)) +
    scale_x_date(date_labels = "%Y-%m") +
    labs(
      x = "Month",
      y = "Total outages",
      title = "Outages per month") +
    theme_minimal()
  }

# Customer-hours lost (week)
plot_customer_hours_weekly <- function(weekly_df,
                                       start_week = NULL,
                                       end_week   = NULL) {
  df <- filter_weekly_range(weekly_df, start_week, end_week)
  ymax <- max(df$customer_hours_lost, na.rm = TRUE)
  
  ggplot(df, aes(x = outage_week, y = customer_hours_lost)) +
    geom_col(width = 7) +
    scale_y_continuous(limits = c(0, ymax * 1.1)) +
    scale_x_date(date_labels = "%Y-%m-%d") +
    labs(
      x = "Week",
      y = "Customer-hours lost",
      title = "Customer-hours lost per week") +
    theme_minimal()
  }

# Customer-hours lost (month)
plot_customer_hours_monthly <- function(monthly_df,
                                        start_month = NULL,
                                        end_month   = NULL) {
  df <- filter_monthly_range(monthly_df, start_month, end_month)
  ymax <- max(df$customer_hours_lost, na.rm = TRUE)
  
  ggplot(df, aes(x = outage_month, y = customer_hours_lost)) +
    geom_col(width = 25) +
    scale_y_continuous(limits = c(0, ymax * 1.1)) +
    scale_x_date(date_labels = "%Y-%m") +
    labs(
      x = "Month",
      y = "Customer-hours lost",
      title = "Customer-hours lost per month") +
    theme_minimal()
  }

```

# Troubleshooting code patterns
```{r}
summarise_troublecode_monthly <- function(df) {
  df |>
    mutate(outage_month = floor_date(outage_day, "month")) |>
    filter(!is.na(TROUBLECODE), TROUBLECODE != "NULL") |>
    group_by(outage_month, TROUBLECODE) |>
    summarise(
      outages = n(),
      .groups = "drop_last") |>
    arrange(outage_month)
  }

plot_troublecode_top_monthly <- function(df, top_n_codes = 5) {
  tc_monthly <- summarise_troublecode_monthly(df)
  
  top_codes <- tc_monthly |>
    group_by(TROUBLECODE) |>
    summarise(total_outages = sum(outages), .groups = "drop") |>
    slice_max(total_outages, n = top_n_codes) |>
    pull(TROUBLECODE)

  tc_monthly |>
    filter(TROUBLECODE %in% top_codes) |>
    ggplot(aes(x = outage_month, y = outages, color = TROUBLECODE)) +
    geom_line() +
    geom_point() +
    scale_x_date(date_labels = "%Y-%m") +
    labs(
      x = "Month",
      y = "Outages",
      color = "Trouble code",
      title = "Monthly outages by top trouble codes") +
    theme_minimal()
  }

```

# Seasonal outage frequency
```{r}
add_season <- function(df) {
  df |>
  mutate(
    month_num = month(outage_day),
    season = case_when(
    month_num %in% c(12, 1, 2)  ~ "Winter",
    month_num %in% 6:8          ~ "Summer",
    TRUE                        ~ "Other"),
    season = factor(season, levels = c("Winter", "Summer", "Other"))
  )
  }

summarise_seasonal_outages <- function(df) {
  df |>
  add_season() |>
  group_by(season) |>
  summarise(
    total_outages   = n(),
    total_customers = sum(TOTALCUSTAFFECTED %||% 0, na.rm = TRUE),
    .groups = "drop")
  }

plot_seasonal_outage_frequency <- function(df) {
  seas <- summarise_seasonal_outages(df)
  
  ggplot(seas, aes(x = season, y = total_outages, fill = season)) +
    geom_col() +
    labs(
      x = "Season",
      y = "Total outages",
      title = "Seasonal outage frequency (Winter vs Summer vs Other)") +
    theme_minimal() +
    theme(legend.position = "none")
  }

```

# Plots
## a) Outages per week / month
```{r}
plot_outages_per_week(weekly_summary)
plot_outages_per_month(monthly_summary)
```

## b) Customer-hours lost
```{r}
plot_customer_hours_weekly(weekly_summary)
plot_customer_hours_monthly(monthly_summary)
```

## c) Troubleshooting code patterns
```{r}
plot_troublecode_top_monthly(outages, top_n_codes = 5)
```

## d) Seasonal outage frequency
```{r}
plot_seasonal_outage_frequency(outages)
```

