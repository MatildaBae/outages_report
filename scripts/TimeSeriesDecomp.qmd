---
title: "Time Series Decomposition"
authors: Jiwon Bae (jb5234) and Hillary Rodriguez (hnr2112)
execute:
  echo: true
  warning: false
  message: false
format:
  html:
    fig-width: 6
    fig-height: 4
    out-width: 60%
    embed-resources: true
---

```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(lubridate)
  library(fs)
  library(tsibble)
  library(fable)
  library(feasts)
  library(slider)
  library(ggdist)
  library(urca)
})

has_prophet <- requireNamespace("prophet", quietly = TRUE)

data_path <- fs::path("..", "data", "PackageData.csv")
outages_raw <- readr::read_csv(data_path, show_col_types = FALSE)
```

# Build daily tsibble
```{r}
prepare_daily_ts <- function(df) {
  df |>
    mutate(
      start_ts = ymd_hms(STARTDATE, tz = "UTC", quiet = TRUE),
      rest_ts  = ymd_hms(RESTDATE,  tz = "UTC", quiet = TRUE),
      outage_day = as.Date(start_ts),
      duration_hours = as.numeric(difftime(rest_ts, start_ts, units = "hours"))) |>
    filter(
      !is.na(outage_day),
      !is.na(duration_hours),
      duration_hours >= 0) |>
    group_by(outage_day) |>
    summarise(
      total_outages   = n(),
      total_customers = sum(coalesce(TOTALCUSTAFFECTED, 0), na.rm = TRUE),
      customer_hours_lost = sum(coalesce(TOTALCUSTAFFECTED, 0) * duration_hours, 
                                na.rm = TRUE),
      .groups = "drop") |>
    mutate(
      severity_index = if_else(total_outages > 0,
                               customer_hours_lost / total_outages,
                               NA_real_)) |>
    as_tsibble(index = outage_day)
  }

daily_ts <- prepare_daily_ts(outages_raw)
daily_ts |> head()
```

# Trend analysis
```{r}
fit_outage_trend_stl <- function(daily_tsibble) {
  daily_tsibble |>
    model(
      stl = STL(
        total_outages ~ trend(window = 21) +
          season(period = "year")))
  }

plot_outage_trend <- function(daily_tsibble) {
  fit <- fit_outage_trend_stl(daily_tsibble)
  comps <- components(fit)
  
  autoplot(comps) +
  labs(
    title = "STL decomposition of daily outages",
    subtitle = "Trend + seasonal pattern + remainder") +
  scale_x_date(date_labels = "%Y-%m")
}

# Plot
plot_outage_trend(daily_ts)
```

# Seasonality analysis
```{r}
plot_outage_seasonality <- function(daily_tsibble) {
  daily_tsibble |>
    gg_season(total_outages, period = "year") +
    labs(
      title = "Seasonal pattern in daily outages",
      y = "Outages") +
    scale_x_date(date_labels = "%m")
}

# Plot
plot_outage_seasonality(daily_ts)
```

# Weekly series for forecasting
```{r}
prepare_weekly_ts <- function(daily_tsibble) {
  daily_tsibble |>
  index_by(outage_week = floor_date(outage_day, "week", week_start = 1)) |>
  summarise(
    total_outages   = sum(total_outages, na.rm = TRUE),
    total_customers = sum(total_customers, na.rm = TRUE),
    customer_hours_lost = sum(customer_hours_lost, na.rm = TRUE),
    severity_index = if_else(total_outages > 0,
    customer_hours_lost / total_outages,
    NA_real_))
  }

weekly_ts <- prepare_weekly_ts(daily_ts)
weekly_ts |> head()
```

## ARIMA for outage frequency (weekly)
```{r}
fit_arima_outages <- function(weekly_tsibble) {
  weekly_tsibble |>
    model(arima = ARIMA(total_outages))
  }

forecast_arima_outages <- function(weekly_tsibble, h = 26) {
  fit <- fit_arima_outages(weekly_tsibble)
  fit |> forecast(h = h)
  }

plot_arima_outage_forecast <- function(weekly_tsibble, h = 26) {
  fc <- forecast_arima_outages(weekly_tsibble, h = h)

  fc |>
  autoplot(weekly_tsibble) +
  labs(
    title = "ARIMA forecast for weekly outage frequency",
    x = "Week",
    y = "Total outages")
}

# ARIMA forcast plot
plot_arima_outage_forecast(weekly_ts, h = 26)
```



